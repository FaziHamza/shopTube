<nz-spin [nzSpinning]="saveLoader" [nzSize]="'large'">
  <!-- <nz-modal [(nzVisible)]="isVisible" nzWidth=700px nzTitle="The first Modal" (nzOnCancel)="handleCancel()">
  <ng-container *nzModalContent>
    <label class="form-label ml-3 text-base font-bold w-3/12">Column Name</label>
    <input nz-input type="text" class="form-control ml-1  w-4/12" placeholder="Enetr Column Name"
      [(ngModel)]="columnName">
  </ng-container>
</nz-modal> -->
  <div *ngIf="data?.isAddRow == undefined ? true: data?.isAddRow" class="p-2 !mt-1.5 bg-white rounded-md">
    <button nz-button (click)="addRow()" *ngIf="!checkType" nzType="primary"> <i class="fa-regular fa-plus mr-2"></i>
      Add</button>
    <button nz-button (click)="addColumn()" *ngIf="checkType" nzType="primary"> <i class="fa-regular fa-plus mr-2"></i>
      Add</button>
  </div>
  <div  class="text-right mb-2 flex justify-between items-center">
    <button *ngIf="data?.isAllowExcelReport && !childTable" nz-button (click)="exportToExcel()" nzType="primary"
      class="!rounded-md !bg-green-500 !text-white hover:!bg-green-600 !h-[32px] hover:text-white !border !border-transparent !hover:border-transparent font-md text-lg">Download
      Excel<i class="fa-regular fa-download ml-2"></i></button>
      <div *ngIf="data?.isAllowSearch && !childTable">
        <nz-input-group nzSearch [nzAddOnAfter]="suffixIconButton">
          <input type="text" class="!h-[32px] !rounded-tl-md !rounded-bl-md" nz-input id="searchControll"
            [(ngModel)]="searchValue" placeholder="Search..." />
        </nz-input-group>
        <ng-template #suffixIconButton>
          <button nz-button nzType="primary" class="!rounded-tr-md !rounded-br-md !w-10 !h-[32px] !bg-blue-600 hover:!bg-blue-500" nzSearch nz-tooltip nzTooltipTitle="Click Here To Filter">
            <i class="fa-solid fa-magnifying-glass" (click)="search()"></i>
          </button>
        </ng-template>
      </div>
  </div>



  <div class="dynamic-table" [processData]="processData"
    [appConfigurableSelect]="childTable == false ? (data?.appConfigurableEvent ? data?.appConfigurableEvent : []) : []"
    [loadAction]="childTable == false ? ( data?.eventActionconfig ? data?.eventActionconfig : {}) : false">
    <nz-table #editRowTable [nzPageSize]="10" [nzData]="displayData"
      *ngIf="data && displayData" [nzLoading]="data?.nzLoading" [nzPaginationPosition]='data?.nzPaginationPosition'
      [nzPaginationType]='data?.nzPaginationType' [nzFrontPagination]='false' [nzTitle]='data?.nzTitle'
      [nzSize]="data.nzSize" [nzSimple]="data.nzSimple" [nzShowSizeChanger]="data.nzShowSizeChanger">
      <thead class="desktop-toggle">
        <tr class="desktop-toggle " *ngIf="data?.showColumnHeader == undefined ? true : data?.showColumnHeader">
          <th class="!font-semibold !text-gray-500 !uppercase !text-xs !text-center" *ngIf="data.showCheckbox"
            [(nzChecked)]="allChecked" [nzIndeterminate]="indeterminate" (nzCheckedChange)="checkAll($event)"></th>
          <ng-container *ngFor="let header of tableHeaders">
            <th class="!font-semibold !text-gray-500 !uppercase !text-xs !text-center"
              *ngIf="header.key !== 'defaultValue' && (header?.show === 'yes' || header?.show === undefined || header?.show === '')"
              [nzSortOrder]="header?.sortOrder" [nzSortFn]="header?.sortFn" [nzSortDirections]="header?.sortDirections"
              [nzFilterMultiple]="header?.filterMultiple" [nzFilters]="header?.listOfFilter"
              [nzFilterFn]="header?.filterFn"
              (click)="header?.columnClickApi ? onClickColumn(header.columnClickApi,header): ''">
              {{header['title'] ? header['title'] : header['name']| translate}}<span>
                <a nz-dropdown [nzDropdownMenu]="menu" *ngIf="header?.isAllowGrouping">
                  <i class="fa-regular fa-ellipsis-v ml-4"></i>
                </a>
                <nz-dropdown-menu #menu="nzDropdownMenu">
                  <ul nz-menu nzSelectable class="!p-1.5">
                    <li nz-menu-item (click)="groupedFunc(header['key'] , 'add' , header , true)">
                      Grouped By {{ header['title'] ? header['title'] : header['name'] | translate }}
                    </li>
                    <li nz-menu-item (click)="groupedFunc(header['key'], 'remove' , header , true)">
                      Stopped Grouped By {{ header['title'] ? header['title'] : header['name'] | translate }}
                    </li>
                  </ul>
                </nz-dropdown-menu>

              </span> <span *ngIf="header?.gridHeaderSum">({{header?.gridHeaderSum}})</span>
            </th>
          </ng-container>
          <th *ngIf="isAllowEdit(tableHeaders)" class="!text-gray-500 !text-center !uppercase">Edit</th>
          <th *ngIf="tableHeaders.length > 0 && (data?.isDeleteAllow || data?.isDeleteAllow == undefined)"
            class="!text-gray-500 !text-center !uppercase">Delete</th>
        </tr>
      </thead>
      <tbody class="dynamic-responsive-table-body w-full" style="width: 100%;">
        <ng-template #recursiveList let-data1>
          <ng-container *ngFor="let item of data1; let i = index">
            <tr [ngStyle]="{'background': item?.color}" (click)="rowselected(item)" class="desktop-toggle"
              (dblclick)="updateModel(item)" (click)="data?.rowClickApi!='' ? onClickRow(data.rowClickApi,item): ''"
              [ngClass]="{'bg-gray-100' : item === index }">
              <td *ngIf="item.expand != undefined" [(nzExpand)]="item.expand">
                <p class="pb-1 ">
                  ({{item.children.length}})
                </p>
              </td>
              <td *ngIf="data.showCheckbox" [(nzChecked)]="item.checked" (nzCheckedChange)="refreshStatus()"></td>
              <ng-container *ngFor="let header of data['tableKey']; let index = index">
                <td (click)="checkTypeData(item , header)" (click)="startEdit(item.id)" [nzEllipsis]="true" class="5"
                  *ngIf="header?.dataType !='objectType' && header.key != 'headerButton' && header.key != 'footerButton' && header.key != 'expandable' && header.key != 'checked'
                && header.key != 'expand' && header.key !='children' && header.key != 'defaultValue' ">
                  <div class="1" *ngIf="(header?.dataType !='select' || !configurationTable) && header?.dataType !='audioVideoRecorder' && header?.dataType !='image-upload' && header?.dataType != 'repeatSection' && header?.dataType != 'dateTime' && !isMyDataArray(item[header.key]
                )
                   && header?.subDataType != 'datetime-local' && header?.dataType != 'rangePicker' ">
                    <div class="editable-cell"
                      [hidden]="editId === item.id && (configurationTable || header?.editMode == 'yes')">
                      {{item[header.key] | translate}}
                    </div>
                    <input *ngIf="configurationTable ||header?.editMode == 'yes'" [hidden]="editId !== item.id"
                      type="text" nz-input [(ngModel)]="item[header.key]" />
                  </div>
                  <div *ngIf=" isMyDataArray(item[header.key]) ">
                    <nz-select nzAllowClear nzShowSearch style="width: 100px" nzPlaceHolder="Select Value"
                      [(ngModel)]="item.defaultValue" (ngModelChange)="select(i, $event)">
                      <nz-option *ngFor="let option of item[header.key]"
                        [nzLabel]="option.type ? option.type : option.key"
                        [nzValue]="option.value ? option.value : option">
                      </nz-option>
                    </nz-select>
                  </div>
                  <div *ngIf="header?.dataType == 'repeatSection'">
                    <div class="editable-cell" *ngIf="editId != item.id">
                      {{item[header.key] | translate}}
                    </div>
                    <nz-select *ngIf="editId == item.id && (configurationTable || header?.editMode)" nzAllowClear
                      nzShowSearch style="width: 100px" nzPlaceHolder="Select Value" [(ngModel)]="item[header.key]">
                      <nz-option *ngFor="let option of item[header.key+'_list']" [nzLabel]="option.label "
                        [nzValue]="option.value ">
                      </nz-option>
                    </nz-select>
                  </div>
                  <div *ngIf="header?.dataType =='image-upload'" class="4">
                    <img nz-image width="80px" height="80px" *ngIf="item[header.key]"
                      [nzSrc]="serverPath +item[header.key]" alt />
                  </div>
                  <ng-container
                    *ngIf="header?.dataType =='input' && tableHeaders[index]?.subDataType == 'datetime-local'">
                    <ng-container *ngIf="item[header.key]">
                      {{ item[header.key] | date:'dd-MM-yyyy HH:mm:ss'}}
                    </ng-container>
                  </ng-container>
                  <ng-container *ngIf="header?.dataType =='dateTime'">
                    <ng-container *ngIf="item[header.key] && editId != item.id">
                      {{ item[header.key] | date:'dd-MM-yyyy'}}
                    </ng-container>
                    <ng-container *ngIf="editId == item.id && (configurationTable || header?.editMode)">
                      <input [(ngModel)]="item[header.key]" type="date">
                    </ng-container>
                  </ng-container>
                  <ng-container *ngIf="header?.dataType =='objectType'">
                    {{item[header.key]}}
                  </ng-container>
                  <div *ngIf="header?.dataType =='rangePicker'" class="date">
                    {{ transform(item[header.key]) }}
                  </div>
                  <div *ngIf="header?.dataType =='audioVideoRecorder'" class="!h-fit">
                    <audio class="!w-[210px] !h-[30px]" controls>
                      <source [src]="item[header.key] ? serverPath + '/' + item[header.key] : ''" type="audio/mp3">
                    </audio>
                  </div>
                </td>
                <td class="5" *ngIf="header?.dataType =='objectType'"
                  [class]="item[header.key] == 'open' ? 'bg-red-500' : (item[header.key] == 'inProgress' ? 'bg-orange-500' : (item[header.key] == 'completed' ? 'bg-green-500' : 'bg-gray-500')) + ' text-white'">
                  {{item[header.key]}}
                </td>
                <td *ngIf="header.key == 'headerButton'">
                  <button (click)="showModal('Header')" type="button"
                    class="bg-blue-600 hover:bg-blue-500 text-white font-bold py-1  px-2.5 rounded">
                    Button
                  </button>
                </td>
                <td *ngIf="header.key == 'footerButton'">
                  <button type="button" (click)="showModal('Footer')"
                    class="bg-blue-600 hover:bg-blue-500 text-white font-bold py-1  px-2.5 rounded">
                    Button
                  </button>
                </td>
              </ng-container>
              <td *ngIf="isAllowEdit(tableHeaders)" (click)="saveEdit(item)">
                <i class="fa-regular !text-sm fa-save text-blue-500"></i>
              </td>
              <td *ngIf="data?.isDeleteAllow || data?.isDeleteAllow == undefined">
                <a nz-popconfirm nzPopconfirmTitle="Sure to delete?" (nzOnConfirm)="deleteRow(item)">
                  <i class="fa-regular fa-trash !text-sm text-red-500"></i>
                </a>
              </td>

            </tr>
            <tr *ngIf="item.expand != undefined" [nzExpand]="item.expand">
              <ng-container *ngIf="item?.children && item.expand">
                <dynamic-table [tableId]='item.tableId' [childTable]='true' *ngIf="item?.children.length > 0"
                  [checkType]="false" [tableData]='item?.children' [tableHeaders]='item?.tableHeaders'
                  [formlyModel]="formlyModel" [form]="form" [screenId]="screenId" [data]="data"
                  [displayData]="item?.children" [screenName]="screenName"
                  [configurationTable]="item?.showEditInput ? item?.showEditInput : false"
                  [showPagination]="false"></dynamic-table>
              </ng-container>
            </tr>
            <div (dblclick)="updateModel(item)" class="dynamic-responsive-table mobile-toggle" style="width: 100%;">
              <tr *ngFor="let entryKey of getObjectKeys(item)">
                <ng-container *ngFor="let header of tableHeaders; let index = index">
                  <ng-container *ngIf="header.key == entryKey">
                    <td class="font-bold bg-blue-600 !text-white hover:text-black">{{header['title'] ? header['title'] :
                      header['name']| translate}}</td>
                    <td *ngIf="entryKey == 'expand'" [(nzExpand)]="item[entryKey]"></td>
                    <td class="responsive-checkBox" *ngIf="data.showCheckbox && entryKey == 'checked'"
                      [(nzChecked)]="item.checked" (nzCheckedChange)="refreshStatus()"></td>
                    <td *ngIf="header?.dataType !='objectType' && header.key != 'headerButton' && header.key != 'footerButton' && header.key != 'expandable' && header.key != 'checked'
                  && header.key != 'expand' && header.key != 'defaultValue' ">
                      <ng-container class="editable-cell" *ngIf="editingEntry == entryKey && configurationTable">
                        <input nz-input type="text" [(ngModel)]="item[entryKey]">
                      </ng-container>
                      <ng-container *ngIf="editingEntry != entryKey">
                        {{ item[entryKey] }}
                      </ng-container>
                    </td>
                    <td *ngIf="header?.dataType =='select' && configurationTable || isMyDataArray(item[header.key]) ">
                      <nz-select nzAllowClear nzShowSearch style="width: 100px" nzPlaceHolder="Select Value"
                        [(ngModel)]="item.defaultValue" (ngModelChange)="select(i, $event)">
                        <nz-option *ngFor="let option of item[header.key]"
                          [nzLabel]="option.type ? option.type : option.key"
                          [nzValue]="option.value ? option.value : option">
                        </nz-option>
                      </nz-select>
                    </td>
                    <td *ngIf="header?.dataType =='image-upload'" class="4">
                      <img nz-image width="80px" height="80px"
                        [nzSrc]="item[header.key] ? item[header.key] :'https://zos.alipayobjects.com/rmsportal/jkjgkEfvpUPVyRjUImniVslZfWPnJuuZ.png'"
                        alt />
                    </td>
                    <td *ngIf="header?.dataType =='input' && tableHeaders[index]?.subDataType == 'datetime-local'">
                      {{ item[header.key] | date:'dd-MM-yyyy HH:mm:ss'}}
                    </td>
                    <td *ngIf="header?.dataType =='rangePicker'" class="date">
                      <!-- {{ item[header.key]}} -->
                      {{ transform(item[header.key]) }}
                    </td>
                    <td class="5" *ngIf="header?.dataType =='objectType'"
                      [ngStyle]="{'background':tableHeaders[index]?.columnColor}">
                      {{tableHeaders[index]?.columnColor}}
                      {{item[header.key]}}
                    </td>
                  </ng-container>
                </ng-container>
              </tr>
              <tr *ngIf="data?.isDeleteAllow || data?.isDeleteAllow == undefined">
                <td class="font-bold bg-blue-500 text-white hover:text-black">Action</td>
                <td>
                  <a nz-popconfirm nzPopconfirmTitle="Sure to delete?" (nzOnConfirm)="deleteRow(item)">
                    <i class="fa-regular fa-trash !text-red-500"></i>
                  </a>
                </td>
              </tr>
              <br>
            </div>
          </ng-container>
        </ng-template>
        <ng-container *ngTemplateOutlet="recursiveList; context:{ $implicit: editRowTable.data }"></ng-container>
      </tbody>
      <tfoot *ngIf="data?.nzFooter && !responsiveTable" class="bg-gray-100">
        <tr nz-custom-footer>
          {{data?.nzFooter}}
          <td nzWidth="40px" *ngIf="data.expandable"></td>
          <td *ngIf="data.showCheckbox" nzWidth="60px"></td>
          <td *ngFor="let header of footerData"> <span *ngIf="header.gridFooterSum">
              ({{header.gridFooterSum}})</span>
          </td>
        </tr>
      </tfoot>
    </nz-table>
    <div class="paginatio-bottom !mt-1.5"
      *ngIf="data?.nzShowPagination && data.totalCount > data?.end && showPagination">
      <div>
        <p class="showing">Showing <span>{{start}} - {{end ? end : data?.end}}</span> from
          <span>{{data.totalCount}}</span> data
        </p>
      </div>
      <div>
        <nz-pagination [nzTotal]="data.totalCount" [(nzPageIndex)]="data.pageIndex"
          [(nzPageSize)]="pageSize ? pageSize : data.end" (nzPageIndexChange)="onPageIndexChange($event)">
        </nz-pagination>
      </div>
    </div>
  </div>


  <div class="p-[6px] pl-0">
    <button nz-button *ngIf="configurationTable" (click)="save()" nzType="primary"> <i
        class="fa-regular fa-floppy-disk mr-2"></i> Save Change</button>
  </div>
  <nz-modal [nzWidth]="1400" [(nzVisible)]="isHeaderVisible" nzTitle="Grid Rule" (nzOnCancel)="handleCancel()"
    (nzOnOk)="handleOk()">
    <ng-container *nzModalContent>
      <st-business-rule-grid [GridType]="GridType" [selectedNode]="_dataSharedService.selectedNode"
        [screenName]="screenName" [screenId]="screenId" [screens]="_dataSharedService.screenModule"
        [nodes]="_dataSharedService.nodes"></st-business-rule-grid>
    </ng-container>
  </nz-modal>

  <!-- <div *ngIf="this.issueReport['issueReport'] && this.issueReport['issueReport']?.length  > 0">
  <st-task-report (notify)="updateIssues($event)" class="close-icon" [item]="this.issueReport"
    [screenName]="this.issueReport['issueReport'][0].screenId" [assignToresponse]="this.assignToresponse"
    [type]="'userTaskManagement'" [userTaskManagementData]="tasks"></st-task-report>
</div> -->
</nz-spin>
<ng-container *ngIf="data && showChild">
  <ng-container *ngIf="data.children">
    <st-main [mainData]="data" *ngIf="data?.children.length > 0 && !configurationTable" [screenName]="screenName"
      [form]="form" [formlyModel]="formlyModel"></st-main>
  </ng-container>
</ng-container>