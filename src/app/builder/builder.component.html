<nz-spin [nzSpinning]="saveLoader" [nzSize]="'large'">
  <div class="flex">
    <div class="w-1/12 mt-1 ml-1">
      <label class="pr-2 pt-2">Departments</label>
    </div>
    <div class="w-1/6">
      <nz-select nzShowSearch nzAllowClear [(ngModel)]="selectDepartmentName"
        (ngModelChange)="getApplications(selectDepartmentName)" placeholder="Select Departments">
        <nz-option [nzValue]="item._id" [nzLabel]="item.name" *ngFor="let item of departmentData"></nz-option>
      </nz-select>
    </div>
    <div class="w-1/12 mt-1 ml-1">
      <label class="pr-2 pt-2">Applications</label>
    </div>
    <div class="w-1/6">
      <nz-select nzShowSearch nzAllowClear [(ngModel)]="selectApplicationName"
        (ngModelChange)="getScreenBuilder(selectApplicationName)" placeholder="Select Applications">
        <nz-option [nzValue]="item._id" [nzLabel]="item.name" *ngFor="let item of applicationData"></nz-option>
      </nz-select>
    </div>
    <!-- <div class="w-1/4 text-right">
      <input type="color" (input)="setCustomColor($event)">
    </div> -->
    <div class="w-2/4">
      <div class="text-right">
        <!-- <button class="custom-color" nz-button nzType="primary">Preveiw</button>
        <button class="custom-color" nz-button nzType="primary" class="mx-2">Print</button> -->
        <nz-button-group>
          <button nz-button nzType="primary" (click)="applyOfflineDb('previous')">
            <span nz-icon nzType="left"></span>
            Backward
          </button>
          <button nz-button nzType="primary" (click)="applyOfflineDb('next')">
            Forward
            <span nz-icon nzType="right"></span>
          </button>
          <button nz-button nzType="primary" (click)="applyOfflineDb('delete')">
            Delete
            <span nz-icon nzType="delete"></span>
          </button>
        </nz-button-group>
        <button class="ml-2" nz-button nzType="primary" routerLink="/pages/{{screenId}}">
          Go To Page
          <span nz-icon nzType="file-done"></span>
        </button>
        <!-- <button type="button" class="btn btn-warning ml-2" (click)="openProductInvoice('preview')"><i
            class="uil-file-alt"></i> Preveiw</button> -->
        <!-- <button type="button" class="btn btn-primary ml-2" (click)="openProductInvoice('pdf')"><i class="uil-print"></i>
          Print</button> -->
        <!-- <div class="btn-group ml-2" role="group">
          <button type="button" (click)="openOldJSON('previous')" class="btn btn-primary"><i class="fa fa-chevron-left"
              aria-hidden="true"></i></button>
          <button type="button" (click)="openOldJSON('next')" class="btn btn-primary"><i class="fa fa-chevron-right"
              aria-hidden="true"></i></button> -->
      </div>
    </div>
  </div>
  <nz-card nzTitle>
    <div class="flex header-tab mb-1">
      <div class="w-1/5 jsonEdiotTab">
        <button nz-button nzType="primary" class title="Layer" (click)="LayerShow()"
          ngbTooltip="Show/hide builder layer">
          <span nz-icon nzType="group" nzTheme="outline"></span>
        </button>
        <button nz-button nzType="primary" class="ml-2 " title="Json Edit" (click)="JsonEditorShow()"
          ngbTooltip="Edit json">
          <span nz-icon nzType="edit" nzTheme="outline"></span>
        </button>
        <button nz-button nzType="primary" [nzLoading]="saveLoader" class="ml-2 " title="Json save"
          (click)="openModal('saveAsTemplate')" ngbTooltip="Save screen"><span nz-icon nzType="save"
            nzTheme="outline"></span> </button>
        <button nz-button nzType="primary" class="ml-2" (click)="clearChildNode()">
          <span nz-icon nzType="plus-circle" nzTheme="outline"></span></button>
        <!-- <button nz-button nzType="primary" class="ml-2" (click)="saveBuilderTemplates()">
          <span nz-icon nzType="plus-circle" nzTheme="outline"></span></button> -->
      </div>
      <div class="w-3/5">
        <nz-select style="padding-left: 4px;" nzShowSearch nzAllowClear [(ngModel)]="screenName"
          (ngModelChange)="getScreenData($event)" placeholder="Select Screen">
          <nz-option [nzValue]="item.name" [nzLabel]="item.name" *ngFor="let item of screens"></nz-option>
        </nz-select>
      </div>
      <div class="w-1/6 jsonEdiotTab ml-1">
        <button nz-button nz-dropdown nzBlock [nzDropdownMenu]="menu" nzType="primary">
          Json Actions
          <span nz-icon style="padding-left: 10px;
          padding-top: 5px;" nzType="down"></span>
        </button>
        <nz-dropdown-menu #menu="nzDropdownMenu">
          <ul nz-menu>
            <li nz-menu-item>
              <a (click)="downloadJson()">Download Json</a>
            </li>
            <li nz-menu-item>
              <a onclick="document.getElementById('fileInput').click()">Json
                Upload</a>
            </li>
            <li nz-menu-item>
              <a (click)="pasteFromClipboard()">Paste</a>
            </li>
            <li nz-menu-item>
              <a (click)="selectedDownloadJson()">Selected Json Download</a>
            </li>
            <li nz-menu-item>
              <a onclick="document.getElementById('selectedFileInput').click()">Selected
                Json Upload</a>
            </li>
          </ul>
        </nz-dropdown-menu>
        <input type="file" class="form-control" id="fileInput" style="display:none" (change)="jsonUpload($event)">
        <input type="file" class="form-control" id="selectedFileInput" style="display:none"
          (change)="selectedJsonUpload($event)">
      </div>
      <div class="w-1/6 jsonEdiotTab ml-1">
        <button nz-button nz-dropdown nzBlock [nzDropdownMenu]="bulkmenu" nzType="primary">
          Bulk
          <span nz-icon style="padding-left: 10px;
          padding-top: 5px;" nzType="down"></span>
        </button>
        <nz-dropdown-menu #bulkmenu="nzDropdownMenu">
          <ul nz-menu>
            <li nz-menu-item>
              <a (click)="bulkUpdate()">Bulk Update</a>
            </li>
            <li nz-menu-item>
              <a>Bulk Import</a>
            </li>
          </ul>
        </nz-dropdown-menu>
        <input type="file" class="form-control" id="fileInput" style="display:none" (change)="jsonUpload($event)">
        <input type="file" class="form-control" id="selectedFileInput" style="display:none"
          (change)="selectedJsonUpload($event)">
      </div>
    </div>
    <div class="flex body-tab border ">
      <as-split style="width: 100%; height: 500px;" [gutterSize]="3">
        <div class="side-btn " (click)="LayerShow()">
          <span nz-icon nzType="right" nzTheme="outline"></span>
        </div>
        <as-split-area [size]="sizes[0]">
          <div>
            <div class="card " *ngIf="IslayerVisible">
              <div class="card-header d-flex justify-content-between bg-blue-500 p-2">
                <p class="text-white text-md ">Builder Layers</p>
              </div>
              <div class="card-body ">
                <nz-input-group nzSearch nz-col nzSpan="24" [nzAddOnAfter]="suffixIconButton">
                  <input type="text" nz-input id="mySearch" [(ngModel)]="searchValue" placeholder="Search..">
                </nz-input-group>
                <ng-template #suffixIconButton>
                  <button nz-button nzType="primary" nzSearch><span nz-icon nzType="search"></span></button>
                </ng-template>

                <ul id="search-menu" *ngIf="filterMenuData.length > 0  ">
                  <div *ngFor="let item of filterMenuData">
                    <li class="menu-labels d-flex justify-content-between">{{item.title
                      | uppercase}}
                      <label (click)="openConfig(item,item)">
                        <span nz-icon nzType="sliders" nzTheme="outline"></span>
                      </label>
                    </li>
                  </div>
                </ul>
                <nz-tree [nzData]="nodes" nzDraggable nzBlockNode [nzSearchValue]="searchValue"
                  (nzOnDrop)="nzEvent($event)">
                  <ng-template #nzTreeTemplate let-node>
                    <div class="flex card-lable-row" (mouseover)="hoverIn(node)" (mouseleave)="hoverOut(node)"
                      [ngClass]="isActiveShow === node.origin.id ? 'isActive' : ''">
                      <div (click)="[openField(node),highlightSelect(node.origin.id,true)]">
                        <span>{{ node.origin.title ? node.title : node.origin.id
                          }}</span>
                      </div>
                      <span *ngIf="screenPage" class="row-icon">
                        <span class=" mx-1" *ngIf="isVisible === node.origin.id" (click)="insertAt(node)">
                          <span class="fa hover:shadow-lg text-blue-500" nz-icon nzType="copy"
                            nzTooltipTitle="Duplicate" nzTheme="outline" nz-tooltip></span>
                        </span>
                        <label class="mx-1" *ngIf="isVisible === node.origin.id" (click)="openConfig(node,node)">
                          <span class="fa hover:shadow-lg text-gray-500" nz-icon nzType="setting"
                            nzTooltipTitle="Configuration" nzTheme="outline" nz-tooltip></span>
                        </label>
                        <label class="mx-1" *ngIf="isVisible === node.origin.id" (click)="remove(node, node)">
                          <span class="fa hover:shadow-lg text-red-500" nz-icon nzType="delete" nzTooltipTitle="Delete"
                            nzTheme="outline" nz-tooltip></span>
                        </label>
                        <label class="mx-1" *ngIf="isVisible === node.origin.id"
                          (click)="openModal('previewJson' , node)">
                          <i nzTooltipTitle="Preview Json " nz-tooltip
                            class="fa-solid fa-brackets-curly hover:shadow-lg text-green-500"></i>
                        </label>
                      </span>
                    </div>
                  </ng-template>
                </nz-tree>
              </div>
            </div>
            <div class="carwd" *ngIf="IsjsonEditorVisible">
              <div class="card-bwody">
                <json-editor id="inputJsonDataa085f" [options]="editorOptions" [(ngModel)]="this.nodes"
                  [options]="editorOptions"></json-editor>
              </div>
            </div>
          </div>
        </as-split-area>
        <as-split-area [size]="sizes[1]" style="height:500px">
          <div class=" col-border col-body-conter" style="position: relative ;">
            <nz-drawer [nzSize]="'large'" [nzWidth]="'80%'" [nzVisible]="IsShowConfig" nzPlacement="right"
              [nzTitle]="'Control List'" [nzExtra]="config" (nzOnClose)="closeConfigurationList()">
              <ng-container *nzDrawerContent>
                <div id="mySidenav-right" class="sidenav-right">
                  <div class="mySidenav-right">
                    <!-- <div class="side-nav-header">
                      <h6>
                        Control List
                      </h6>
                      <a href="javascript:void(0)" class="closebtn"
                        onclick="closeNav2()">
                        <i class="uil uil-times-square"></i>
                      </a>
                    </div> -->
                    <div class="side-nav-body">
                      <nz-tabset>
                        <nz-tab nzTitle="Configuration">
                          <div class=" general_faq mt-3">
                            <div style="position:relative ;">
                              <st-generic-field [modal]="formModalData" (notify)="notifyEmit($event)"
                                [itemData]="fieldData" [type]="fieldData.type" [screenId]="screenId"
                                [screenName]="screenName" *ngIf="fieldData">
                              </st-generic-field>
                            </div>
                          </div>
                        </nz-tab>
                        <nz-tab nzTitle="UI Rule">
                          <st-uirule [selectedNode]="selectedNode" *ngIf="selectedNode && nodes.length  > 0"
                            [screenId]="screenId" [screenName]="screenName" [screens]="screens" [nodes]="nodes"
                            (ruleNotify)="getUIRuleData($event)"></st-uirule>
                          <!-- [screenName]="screenName" [screenModule]="screenModule" [nodes]="nodes" (ruleNotify)="getUIRuleData($event)"></st-uirule> -->
                        </nz-tab>
                        <nz-tab nzTitle="Validation Rule">
                          <st-generic-field [modal]="validationFieldData.modelData" (notify)="notifyEmit($event)"
                            [itemData]="validationFieldData" [type]="validationFieldData.type" [screenId]="screenId"
                            [screenName]="screenName" (deleteValidation)="deleteValidationRule($event)"
                            *ngIf="validationFieldData">
                          </st-generic-field>
                          <!-- <st-validation-rule [configurationData]="validationFieldData"></st-validation-rule> -->
                        </nz-tab>
                        <nz-tab nzTitle="Buisness Rule">
                          <st-business-rule [selectedNode]="selectedNode" *ngIf="selectedNode" [screenName]="screenName"
                            [screenId]="screenId" [screens]="screens" [nodes]="nodes"
                            (businessRuleNotify)="getBusinessRule()"
                            [formlyModel]="this.formlyModel"></st-business-rule>
                        </nz-tab>
                        <nz-tab nzTitle="Actions">
                          <st-action-rule [selectedNode]="selectedNode" *ngIf="selectedNode" [screenName]="screenName"
                            [formlyModel]="this.formlyModel" [nodes]="nodes" [screens]="screens"></st-action-rule>
                        </nz-tab>
                        <nz-tab nzTitle="Grid Rules">
                          <st-business-rule-grid *ngIf="selectedNode && nodes.length  > 0" [selectedNode]="selectedNode"
                            [screenName]="screenName" [screenId]="screenId" [screens]="screens"
                            [nodes]="nodes"></st-business-rule-grid>
                        </nz-tab>
                      </nz-tabset>
                    </div>
                  </div>
                </div>
              </ng-container>
            </nz-drawer>
            <ng-template #config>
              <!-- <span class="mr-2 text-lg hover:cursor-pointer" nz-icon nzType="close-circle" nzTheme="twotone"
                (click)="closeConfigurationList()"></span> -->
              <button nz-button nzType="primary" (click)="backNode()">Back</button>
              <button nz-button nzType="primary" (click)="nextNode()">Next</button>
              <!-- <button nz-button nzType="default"
                (click)="closeConfigurationList()">Cancel</button>
              &nbsp;
              <button nz-button nzType="primary"
                (click)="closeConfigurationList()">OK</button> -->
            </ng-template>

            <!-- side-nav-right -->
            <nz-drawer [nzSize]="'large'" [nzWidth]="'80%'" [nzVisible]="controlListvisible" nzPlacement="right"
              [nzTitle]="'Control List'" [nzExtra]="extra" (nzOnClose)="controlListClose()">
              <ng-container *nzDrawerContent>
                <div *ngFor="let item of htmlTabsData">
                  <div class="nav-header" style="height:6%">
                    <!-- <h3>{{item.label}}</h3> -->
                    <div class="side-bar-search-row">
                      <div class="search-bar">
                        <ul id="search-menu " *ngIf="searchControllData.length > 0 ">
                          <div class="flex flex-wrap tab-pills z-50">
                            <div class="col-md-3 mb-1 p-1 hover:bg-#1890ff  "
                              *ngFor="let searchItems of searchControllData">
                              <button nz-button class=" rounded w-auto"
                                *ngIf="searchItems.parameter != 'dashonictabsAddNew' && searchItems.parameter != 'stepperAddNew' && searchItems.parameter != 'listWithComponents' && searchItems.parameter != 'kanabnAddNew'  && searchItems.parameter != 'addSection' && searchItems.parameter != 'cvtemplate'  && searchItems.parameter != 'dashnoicPricingTemplate'  && searchItems.parameter != 'login' && searchItems.parameter != 'loremIpsum'  && searchItems.parameter != 'dashnoicPricingTabletemplate' && searchItems.parameter != 'pricingtemplate' && searchItems.parameter != 'registerTemplate' && searchItems.parameter != 'signUpTemplate' && searchItems.parameter != 'profiletemplate' && searchItems.parameter != 'invoiceTemplate'"
                                (click)="addControlToJson(searchItems.parameter,searchItems)"><i
                                  class={{searchItems.icon}}></i><span class="text-wrap">{{searchItems.label}}</span>
                              </button>
                              <ng-container
                                *ngIf="searchItems.parameter != 'cvtemplate'  && searchItems.parameter != 'dashnoicPricingTemplate'  && searchItems.parameter != 'login' && searchItems.parameter != 'loremIpsum'  && searchItems.parameter != 'dashnoicPricingTabletemplate' && searchItems.parameter != 'pricingtemplate' && searchItems.parameter != 'registerTemplate' && searchItems.parameter != 'signUpTemplate' && searchItems.parameter != 'profiletemplate' && searchItems.parameter != 'invoiceTemplate'">
                                <button nz-button class="w-auto rounded"
                                  *ngIf="searchItems.parameter == 'dashonictabsAddNew' || searchItems.parameter == 'listWithComponents' || searchItems.parameter == 'addSection' || searchItems.parameter == 'stepperAddNew' || searchItems.parameter == 'kanabnAddNew' || searchItems.parameter == 'address_form' || searchItems.parameter == 'employee_form' || searchItems.parameter == 'login_Form' || searchItems.parameter == 'signUp_Form'"
                                  (click)="addFunctionsInHtml(searchItems.parameter)"><i class={{searchItems.icon}}></i>
                                  <span class="text-wrap">{{searchItems.label}}</span>
                                </button>
                              </ng-container>
                              <button nz-button nzType="default" nzBlock class="rounded"
                                *ngIf=" searchItems.parameter == 'cvtemplate'  || searchItems.parameter == 'dashnoicPricingTemplate'  || searchItems.parameter == 'login' || searchItems.parameter == 'loremIpsum'  || searchItems.parameter == 'dashnoicPricingTabletemplate' || searchItems.parameter == 'pricingtemplate' || searchItems.parameter == 'registerTemplate' || searchItems.parameter == 'signUpTemplate' || searchItems.parameter == 'profiletemplate' || searchItems.parameter == 'invoiceTemplate'">
                                <span nz-icon nzType="eye"
                                  (mouseover)="openModal('webCode' ,searchItems)"></span>{{searchItems.label}}
                              </button>
                            </div>
                          </div>
                        </ul>
                      </div>
                    </div>
                  </div>
                  <div class="nav-body z-0 " *ngIf="!showSectionOnly">
                    <nz-tabset>
                      <nz-tab (nzSelect)="showWebBlockList(item1.label)" [nzTitle]="item1.label"
                        *ngFor="let item1 of item.children let i= index">
                        <div class="website-block" *ngIf="item1.id == 'website-block'">
                          <div class="btnss-body">
                            <div class="block-Button flex flex-wrap">
                              <div class="p-1 " *ngFor="let blockButton of websiteBlockButton">
                                <button (click)="addTemplate(blockButton,'website-block')" nz-button nzType="default"
                                  nzBlock class="rounded">
                                  <i></i><span class="text-wrap">{{blockButton.label}}</span>
                                </button>
                              </div>
                            </div>
                          </div>
                          <div class="website-block-menu">
                            <ul nz-menu nzMode="inline">
                              <li *ngFor="let webSiteBlock of item1.children" nz-menu-item
                                (click)="loadWebsiteBlockChild(webSiteBlock)">
                                <span class="text-wrap">{{webSiteBlock.label}}</span>
                              </li>
                            </ul>
                          </div>
                        </div>
                        <nz-collapse *ngIf="item1.id != 'website-block'">
                          <nz-collapse-panel *ngFor="let item2 of item1.children let i = index"
                            [nzHeader]="item2.label">
                            <div class="flex flex-wrap">
                              <div class="p-1 w-1/6" *ngFor="let item3 of item2.children">
                                <button nz-button nzType="default" nzBlock class="rounded"
                                  *ngIf="item1.id != 'template' && item3.parameter != 'dashonictabsAddNew' && item3.parameter != 'listWithComponents' && item3.parameter != 'stepperAddNew' && item3.parameter != 'kanabnAddNew'  && item3.parameter != 'addSection' && item1.id != 'webCode'"
                                  (click)=" addControlToJson(item3.parameter,item3)">
                                  <i class={{item3.icon}}></i><span class="text-wrap">{{item3.label}}</span>
                                </button>
                                <button nz-button nzType="default" nzBlock class="rounded"
                                  *ngIf="item3.parameter == 'dashonictabsAddNew' || item3.parameter == 'addSection' || item3.parameter == 'stepperAddNew' || item3.parameter == 'kanabnAddNew' || item3.parameter == 'listWithComponents'"
                                  (click)="addFunctionsInHtml(item3.parameter)">
                                  <i class={{item3.icon}}></i>
                                  <span class="text-wrap">{{item3.label}}</span>
                                </button>
                                <button nz-button nzType="default" nzBlock class="rounded"
                                  *ngIf="item1.id == 'webCode'">
                                  <span class="text-wrap">
                                    <span class="mr-2" nz-icon nzType="eye"
                                      (mouseover)="openModal('webCode',item3)"></span>{{item3.label}}
                                  </span>
                                </button>
                                <button *ngIf="item1.id == 'template'" nz-button nzType="default" nzBlock
                                  class="rounded" (click)="addTemplate(item3,'template')"><span
                                    class="text-wrap">{{item3.label}}</span>
                                </button>
                              </div>
                            </div>
                          </nz-collapse-panel>
                        </nz-collapse>
                      </nz-tab>
                    </nz-tabset>
                  </div>
                </div>
              </ng-container>
            </nz-drawer>
            <ng-template #extra>
              <nz-input-group nzSearch [nzAddOnAfter]="suffixIconButton">
                <input type="text" nz-input id="searchControll" (keyup)="searchControll()" placeholder="Search.." />
              </nz-input-group>
              <ng-template #suffixIconButton>
                <button nz-button nzType="primary" nzSearch><span nz-icon nzType="search"></span></button>
              </ng-template>
            </ng-template>
            <st-pages [resData]="nodes" [screenName]="screenName" [screenId]="screenId" [formlyModel]="formlyModel"
              *ngIf="nodes.length  > 0"></st-pages>
          </div>
        </as-split-area>
      </as-split>
    </div>
  </nz-card>
</nz-spin>

<nz-modal [nzWidth]="modalType === 'previewJson' ? '800px' : '500px'" [(nzVisible)]="showModal"
  [nzTitle]="modalType === 'previewJson' ? 'Selected Json' : (modalType === 'webCode' ? 'Web Template Preview' : (modalType === 'saveAsTemplate' ? 'Save As Template' : ''))"
  (nzOnCancel)="handleCancel()" (nzOnOk)="handleOk()">
  <ng-container *nzModalContent>
    <div *ngIf="modalType == 'previewJson'">
      <div class="mb-2">
        <button nz-button nzType="primary" (click)="selectedDownloadJson()" class="mx-1"
          nz-tooltip="download Json"><span nz-icon nzType="download"></span>Dwonload</button>
      </div>
      <json-editor id="jsonPreview121" [(ngModel)]="selectedNode"></json-editor>
    </div>
    <div class="image-wrapper" *ngIf="modalType == 'webCode'">
      <img *ngIf="htmlBlockimagePreview.content" nz-image [nzSrc]="htmlBlockimagePreview.content" alt />
    </div>
    <div *ngIf="modalType == 'saveAsTemplate'">
      <label for="template-name">Template Name</label>
      <input id="template-name" [(ngModel)]="templateName" nz-input placeholder="Template Name..." />
      <label class="mt-2" nz-checkbox [(ngModel)]="saveAsTemplate">Do you want
        to Save as Template?</label>
      <br>
      <br>
      <label for="template-name">Website Block Name</label>
      <input id="template-name" [(ngModel)]="websiteBlockName" nz-input placeholder="Website Block Name..." />
      <label for="template-name">Website Block Type</label>
      <nz-select nzShowSearch nzAllowClear [(ngModel)]="webisteBlockType">
        <nz-option [nzValue]="item.label" placeholder="Select Block Type..." [nzLabel]="item.label"
          *ngFor="let item of websiteBlockTypeArray"></nz-option>
      </nz-select>
      <label class="mt-2" nz-checkbox [(ngModel)]="websiteBlockSave">Do you want
        to save as block?</label>
      <label class="mt-2" nz-checkbox [(ngModel)]="isTableSave">Are you want to
        save table?</label>
    </div>
  </ng-container>
</nz-modal>
